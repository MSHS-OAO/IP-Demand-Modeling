---
title: "Census-Trending-Dashboard"
author: "HSO"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true

---
  
### Report created on `r format(Sys.Date(), "%m/%d/%y")`
```{r Install and load packages}
# install.packages("dplyr")
# install.packages("lubridate")
# install.packages("readxl")
# install.packages("writexl")
# install.packages("ggplot2")
# install.packages("lubridate")
# install.packages("reshape2")
# install.packages("svDialogs")
# install.packages("stringr")
# install.packages("formattable")
# install.packages("scales")
# install.packages("knitr")
# install.packages("rmarkdown")
# install.packages("kableExtra")

library(dplyr)
library(lubridate)
library(readxl)
library(writexl)
library(ggplot2)
library(lubridate)
library(reshape2)
library(svDialogs)
library(stringr)
library(formattable)
library(scales)
library(knitr)
library(rmarkdown)
library(kableExtra)

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center")
```


```{r Determine drive mapping}
# rm(list = ls())

if (list.files("J://") == "Presidents") {
  user_directory <- "J:/Presidents/HSPI-PM/Operations Analytics and Optimization/Projects/System Operations/COVID Scenario Testing"
} else {
  user_directory <- "J:/deans/Presidents/HSPI-PM/Operations Analytics and Optimization/Projects/System Operations/COVID Scenario Testing"
}

```


```{r Import reference data for unit mappings, admit source, and admit type}


ref_sheet_names <- excel_sheets(path = paste0(user_directory, "/Epic Census Trending/Epic-Oracle-Census-Unit-Mappings-2020-08-05.xlsx"))

ref_data <- lapply(ref_sheet_names, function(x) {read_xlsx(path = paste0(user_directory, "/Epic Census Trending/Epic-Oracle-Census-Unit-Mappings-2020-08-05.xlsx"), sheet = x, na = c("", "NA"))})

unit_mapping <- ref_data[[1]]

admit_source_mapping <- ref_data[[2]]

admission_type_mapping <- ref_data[[3]]

```


```{r Subset, format, and crosswalk Oracle data}

# Remove duplicates and select relevant columns from COVID data
covid_census_subset <- unique(oracle_covid_census_df)

covid_census_subset <- covid_census_subset %>%
  select(CSN, MRN, EXTERNAL_ENC_ID, CENSUS_DATE, 
         CENSUS_DEPT, CENSUS_ROOM, CENSUS_BED,
         ACCOMMODATION_DESC,
         PAT_DAY_INF_STATUS) %>%
  arrange(CSN, CENSUS_DATE, CENSUS_DEPT)

# Remove duplicates from IP census data
ip_census_subset <- unique(oracle_ip_census_df)

ip_census_subset <- ip_census_subset %>%
  arrange(CSN, CENSUS_DATE, CENSUS_DEPT)


# Crosswalk IP census with COVID data to determine daily COVID volume
ip_census_crosswalk <- left_join(ip_census_subset, covid_census_subset,
                                 by = c("CSN" = "CSN", 
                                        "MRN" = "MRN",
                                        "EXTERNAL_ENC_ID" = "EXTERNAL_ENC_ID",
                                        "CENSUS_DATE" = "CENSUS_DATE", 
                                        "CENSUS_DEPT" = "CENSUS_DEPT",
                                        "CENSUS_ROOM" = "CENSUS_ROOM",
                                        "ACCOMMODATION_DESC" = "ACCOMMODATION_DESC",
                                        "CENSUS_BED" = "CENSUS_BED"))

# Format crosswalked data
ip_census_crosswalk <- ip_census_crosswalk %>%
  mutate(CensusDate = as.Date(CENSUS_DATE),
         CensusYear = year(CensusDate),
         CensusMonth = month(CensusDate),
         AdjPatInfStat = ifelse(PAT_DAY_INF_STATUS %in% c("COVID-19", "PUI - COVID", "SUSC COVID"),
                                PAT_DAY_INF_STATUS, NA))

# Crosswalk census data with unit mappings
ip_census_crosswalk <- left_join(ip_census_crosswalk, unit_mapping,
                                 by = c("CENSUS_DEPT" = "CENSUS_DEPT"))

# Crosswalk census data with admit source
admit_source_mapping <- admit_source_mapping %>%
  mutate(`EPIC AdmissionSource` = toupper(`EPIC AdmissionSource`))

ip_census_crosswalk <- left_join(ip_census_crosswalk, admit_source_mapping,
                                 by = c("ADMIT_SOURCE" = "EPIC AdmissionSource"))

# Crosswalk census data with admission type
admission_type_mapping <- admission_type_mapping %>%
  mutate(`EPIC AdmissionType` = toupper(`EPIC AdmissionType`))

ip_census_crosswalk <- left_join(ip_census_crosswalk, admission_type_mapping,
                                 by = c("ADMISSION_TYPE" = "EPIC AdmissionType"))

# Manually update Admission Types of Premature as Newborns
ip_census_crosswalk <- ip_census_crosswalk %>%
  mutate(ADMIT_TYPE_DESC_MSX = ifelse(ADMISSION_TYPE == "PREMATURE", 
                                      "NEWBORN - USE OF THIS CODE NECESSITATES THE USE OF SPECIAL CODES IN THE SOURCE OF ADMISSIONÃ¡(DATA ELEMENT 13).", 
                                      ADMIT_TYPE_DESC_MSX))

# test_df <- ip_census_crosswalk %>%
#   group_by(CensusSite, ADMISSION_TYPE, ADMIT_TYPE_DESC_MSX) %>%
#   summarize(Days = n())
# 
# test_df2 <- ip_census_crosswalk %>%
#   group_by(CensusSite, ADMIT_SOURCE, ADMIT_SOURCE_DESC_MSX) %>%
#   summarize(Days = n())

# Order unit types for plotting
unit_type_order <- c("ICU", "Med Surg", "COVID Surge", "Peds & Peds ICU", "L&D & Postpartum",
                     "Nursery & NICU", "Psych & Rehab", "ED", "Psych ED", "Non-IP")

ip_census_crosswalk$UnitRollUp <- factor(ip_census_crosswalk$UnitRollUp, 
                                         levels = unit_type_order, ordered = TRUE)


```


```{r Begin summarizing data based on site and unit type}
census_site_unit_type <- ip_census_crosswalk %>%
  filter(IPUnit & CensusSite != "MSBI" & !is.na(CensusSite)) %>%
  group_by(CensusSite, UnitRollUp, UnitType, CENSUS_DEPT, CensusDate, CensusYear, CensusMonth) %>%
  summarize(Census = sum(PATIENT_DAY)) %>%
  arrange(CensusSite, CensusDate, UnitRollUp, CensusDate)

```


```{r Plot census trend}

sinai_colors <- c("#221f72", "#00AEEF", "#D80B8C", "#4C4D4C", "#8988dd", "#B2B3B2", "#F887CE", "#79DCFF", "#8F075B", "#00668A")

# Assume 4 week lookback period for now
lookback_period <- 28

# Select maximum number of units per graph
max_num_units <- 8

# Determine start date for trending data based on lookback period
start_date <- (Sys.Date() - 1) - (lookback_period)

```


```{r Custom functions for plotting data for a given site, results = 'asis'}

# Custom function for plotting census
census_plot <- function(data, title) {
  
  num_units <- length(unique(data$CENSUS_DEPT))
  
  census_trend_plot <- ggplot(data = data,
                              aes(x = CensusDate, y = Census, color = CENSUS_DEPT)) + #, shape = CENSUS_DEPT)) +
    geom_line() +
    geom_point() +
    labs(title = title, x = "Date", y = "Census") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, hjust = 0.5),
          legend.position = "bottom",
          legend.box = "horizontal",
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10),
          axis.text.x = element_text(size = 10, angle = 45, vjust = 0.5),
          axis.text.y = element_text(size = 10),
          panel.grid.major = element_line(color = "lightgrey"),
          panel.grid.minor = element_line(color = "lightgrey")) +
    scale_color_manual(name = "Unit", values = sinai_colors[1:length(unique(data$CENSUS_DEPT))]) +
    # scale_shape(name = "Unit") +
    scale_x_date(date_breaks = "7 days", minor_breaks = "1 day", date_labels = "%m/%d/%y",
                 expand = c(0, 1))
  
  print(census_trend_plot)
}

```

```{r Custom function for iterating through data for a given site, results = 'asis'}
# Custom function to iterate through a site's unit types

site_unit_type_plotting <- function(site) {
  
  # Subset census data based on site and start date
  site_df <- census_site_unit_type %>%
    filter(CensusSite == site & CensusDate > start_date)
  
  # Determine unit types for this site
  unit_types <- unique(site_df$UnitRollUp)
  
  for(i in 1:length(unit_types)){
    
    cat("<h3><b>", as.character(unit_types[i]), "</b></h3>")
    
    # Subset data to plot based on unit type roll up at this site
    plot_df <- site_df %>%
      filter(UnitRollUp == unit_types[i])
    
    # Determine if the number of units within this unit type exceeds the 
    # maximum number of units to plot on a given graph
    num_units <- length(unique(plot_df$CENSUS_DEPT))
    
    
    if(num_units <= max_num_units) {
      
      # If the number of units does not exceed the maximum number of units per graph, 
      # specify the title and plot the data as is
      plot_title <- paste0(site, " ", unit_types[i], " Census by Unit")
      
      census_plot(data = plot_df, title = plot_title)
      
    } else {
      
      # If the number of units exceeds the maximum number of units per graph, establish groupings 
      # based on the total number of units and the maximum number of units per graph
      unit_numbers <- data.frame("Unit" = unique(plot_df$CENSUS_DEPT), stringsAsFactors = FALSE)
      unit_numbers <- unit_numbers %>%
        mutate(Number = row_number(),
               Grouping = ceiling(Number / max_num_units))
      
      # Add text to plot title to include number of graphs for this unit type
      plot_df <- left_join(plot_df, unit_numbers[ , c("Unit", "Grouping")], by = c("CENSUS_DEPT" = "Unit"))
      
      for(j in 1:max(plot_df$Grouping)) {
        grouping_df <- plot_df %>%
          filter(Grouping == j)
        
        plot_title <- paste0(site, " ", unit_types[i], " Census by Unit (", j, " of ", max(plot_df$Grouping), ")")
        
        census_plot(data = grouping_df, plot_title)
      }
      
      
    }
    
  }
  
}


```

## MSH Census
```{r Plot MSH census trends, results = 'asis'}
site_unit_type_plotting(site = "MSH")

```

## MSQ Census
```{r Plot MSQ census trends, results = 'asis'}
site_unit_type_plotting(site = "MSQ")

```

## MSB Census
```{r Plot MSB census trends, results = 'asis'}
site_unit_type_plotting(site = "MSB")

```

## MSM Census
```{r Plot MSM census trends, results = 'asis'}
site_unit_type_plotting(site = "MSM")

```

## MSW Census
```{r Plot MSW census trends, results = 'asis'}
site_unit_type_plotting(site = "MSW")

```