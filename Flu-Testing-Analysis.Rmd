---
title: "Flu Test Data Analysis"
author: "HSO"
date: "07/13/2020"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r Install and load packages}
# Code for analyzing historical COVID-19 IP census, admissions, and discharges ----------------------

#Install and load necessary packages --------------------
#install.packages("readraw_dfl")
#install.packages("writeraw_dfl")
#install.packages("ggplot2")
#install.packages("lubridate")
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("svDialogs")
#install.packages("stringr")
#install.packages("formattable")
# install.packages("ggpubr")
# install.packages("rprojroot")

# Load libraries ------------------------
library(readxl)
library(writexl)
library(ggplot2)
library(lubridate)
library(dplyr)
library(reshape2)
library(svDialogs)
library(stringr)
library(formattable)
library(scales)
library(reshape2)
library(knitr)
library(rmarkdown)
library(kableExtra)

```

```{r Determine drive mapping}
rm(list = ls())

if (list.files("J://") == "Presidents") {
  user_directory <- "J:/Presidents/HSPI-PM/Operations Analytics and Optimization/Projects/System Operations/COVID Scenario Testing"
} else {
  user_directory <- "J:/deans/Presidents/HSPI-PM/Operations Analytics and Optimization/Projects/System Operations/COVID Scenario Testing"
}

```


```{r Import raw data}
# Set working directory and select raw data ----------------------------
sinai_colors <- c("#221f72", "#00AEEF", "#D80B8C", "#4C4D4C", "#8988dd", "#B2B3B2", "#F887CE")

site_order <- c("MSH", "MSQ", "MSB", "MSBI", "MSM", "MSW", "MSHS")

flu_season_order <- c("Non-Flu", "Flu")

# Import FY2019 flu test data for Epic sites
epic_sites_flu_raw <- read_excel(paste0(user_directory, "/Flu Test Data/Epic Sites FY2019 Flu Test Data 2020-07-09.xlsx"))

# Import FY2019 flu test data for MSBI
msbi_flu_raw <- read_excel(paste0(user_directory, "/Flu Test Data/MSBI FY2019 Flu Test Data 2020-07-09.xlsx"))

# Import FY2019 IP discharge data
ip_disch_df_raw <- read_excel(paste0(user_directory, "/IP Discharge Data/IP Disch FY2019 2020-05-13.xlsx"), na = c("", "NA"),
                              col_types = c("text", "text", "text", "text", "date", "date", "date",
                                            "text", "text", "text", "text", "text", "text", "text",
                                            "numeric", "numeric"))

# 
# Import analysis reference
reference_file <- paste0(user_directory, "/Flu Test Data/Analysis Reference 2020-07-08.xlsx")
ref_sheets <- excel_sheets(reference_file)

ref_data <- lapply(ref_sheets, function(x) read_excel(reference_file, sheet = x))

site_ref <- ref_data[[1]]
dispo_ref <- ref_data[[2]]

```

```{r Preprocess data for Epic sites}
epic_sites_flu_df <- epic_sites_flu_raw

# Filter out non-ED or non-IP flu tests
epic_sites_flu_df <- epic_sites_flu_df %>%
  filter(`Patient Class` == "Emergency" | `Patient Class` == "Inpatient" & !is.na(`Patient Class`))

# Crosswalk sites
epic_sites_flu_df <- left_join(epic_sites_flu_df, site_ref, by = c("Location" = "Location"))


# Determine order and result months
epic_sites_flu_df <- epic_sites_flu_df %>%
  mutate(OrderYear = year(`Order Date`),
         OrderMonth = month(`Order Date`), 
         ResultYear = year(`LAST RESULT DATE`),
         ResultMonth = month(`LAST RESULT DATE`),
         TestResult = ifelse(!is.na(`MSHS Positive Flu Result (ORD)`), "Flu Positive", "Flu Negative"),
         AdmittedIP = `Patient Class` == "Inpatient" | (`Patient Class` == "Emergency" & `ED Disch Disposition` == "Admit"))

# Subset dataframe
epic_sites_flu_subset <- epic_sites_flu_df %>%
  select(Site, Department, MRN, `Visit Number`, `Patient Class`,
         `Order ID`, `Order Description`, `Order Date`, OrderYear, OrderMonth,
         `LAST RESULT DATE`, ResultYear, ResultMonth, 
         TestResult, `ED Disch Disposition`, AdmittedIP)

colnames(epic_sites_flu_subset) <- c("Site", "Department", "MRN", "VisitNumber", "PtClass",
                                     "OrderID", "OrderDesc", "OrderDate", "OrderYear", "OrderMonth",
                                     "ResultDate", "ResultYear", "ResultMonth", 
                                     "TestResult", "EDDispo", "AdmittedIP")

```

```{r Preprocess MSBI data}
msbi_flu_df <- msbi_flu_raw

# Create column for site name
msbi_flu_df$Site <- "MSBI"

# Determine order and result months
msbi_flu_df <- msbi_flu_df %>%
  mutate(OrderYear = year(`Order Date`),
         OrderMonth = month(`Order Date`), 
         ResultYear = year(`LAST RESULT DATE`),
         ResultMonth = month(`LAST RESULT DATE`),
         TestResult = ifelse(!is.na(`MSHS Positive Flu Result (ORD)`), "Flu Positive", "Flu Negative"),
         AdmittedIP = NA) #  Will need to crosswalk MSBI data with IP discharge data to determine if patient has been admitted.

# Subset dataframe
msbi_flu_subset <- msbi_flu_df %>%
  select(Site, Department, MRN, `Visit Number`, `Patient Class`,
         `Order ID`, `Order Description`, `Order Date`, OrderYear, OrderMonth,
         `LAST RESULT DATE`, ResultYear, ResultMonth, 
         TestResult, `ED Disch Disposition`, AdmittedIP)

colnames(msbi_flu_subset) <- c("Site", "Department", "MRN", "VisitNumber", "PtClass",
                                     "OrderID", "OrderDesc", "OrderDate", "OrderYear", "OrderMonth",
                                     "ResultDate", "ResultYear", "ResultMonth", 
                                     "TestResult", "EDDispo", "AdmittedIP")

```

```{r Combine data for Epic sites and MSBI}
system_flu_subset <- rbind(epic_sites_flu_subset, msbi_flu_subset)

```

```{r Create dataframe with total days in each month}
fy2019_dates <- seq(from = as.Date("1/1/19", format = "%m/%d/%y"), to = as.Date("12/31/19", format = "%m/%d/%y"),
                    by = 1)

days_per_month <- data.frame("Date" = fy2019_dates)

days_per_month <- days_per_month %>%
  mutate(Month = month(Date),
         Year = year(Date),
         MonthYear = as.Date(paste0(Month, "/1/", Year), format = "%m/%d/%Y"))

days_per_month <- days_per_month %>%
  group_by(Year, Month, MonthYear) %>%
  summarize(DaysPerMonth = n()) %>%
  mutate(EndDate = MonthYear + DaysPerMonth - 1) %>%
  ungroup()

days_per_month_site <- days_per_month[rep(row.names(days_per_month), length(unique(system_flu_subset$Site))), ]

site_list <- data.frame("Site" = unique(system_flu_subset$Site), stringsAsFactors = FALSE)
site_list <- data.frame("Site" = site_list[rep(row.names(site_list), nrow(days_per_month)), ], 
                        stringsAsFactors = FALSE)
site_list <- site_list %>%
  arrange(Site)

site_start_dates <- system_flu_subset %>%
  group_by(Site, OrderYear) %>%
  summarize(DataStartDate = as.Date(min(OrderDate), format = "%Y-%m-%d"),
            DataStartMonth = OrderMonth[which.min(OrderDate)])

days_per_month_site <- cbind(days_per_month_site, site_list)

days_per_month_site <- left_join(days_per_month_site, site_start_dates, 
                                 by = c("Site" = "Site", 
                                        "Year" = "OrderYear"))

days_per_month_site <- days_per_month_site %>%
  mutate(DaysPerMonth = ifelse(DataStartDate == as.Date("2019-01-01", format = "%Y-%m-%d"), 
                                DaysPerMonth,
                                ifelse(DataStartMonth > Month, 0,
                                       ifelse(DataStartMonth == Month, EndDate - DataStartDate + 1, 
                                              DaysPerMonth))))

days_per_month_site <- days_per_month_site %>%
  select(Site, Year, Month, MonthYear, DaysPerMonth)

```

### Flu Test Volume
#### FY2019 Flu Test Volume (ED and IP Only)
```{r Format flu data for graphing volume trends}

# Determine number of days in each month
system_daily_volume <- system_flu_subset %>%
  group_by(OrderYear, OrderMonth, OrderDate) %>%
  summarize(Count = n())

system_flu_subset$Site <- factor(system_flu_subset$Site, levels = site_order, ordered = TRUE)

system_flu_subset <- system_flu_subset %>%
  mutate(OrderMonthYear = as.Date(paste0(OrderMonth, "/1/", OrderYear), format = "%m/%d/%Y")) %>%
  arrange(Site)

system_flu_subset <- left_join(system_flu_subset, days_per_month_site[ , c("Site", "MonthYear", "DaysPerMonth")], 
                               by = c("Site" = "Site",
                               "OrderMonthYear" = "MonthYear"))

# Summarize data for graphing
site_daily_flu_volume <- system_flu_subset %>%
  group_by(Site, OrderDate) %>%
  summarize(VolumeOrdered = n())

site_monthly_flu_volume <- system_flu_subset %>%
  group_by(Site, OrderMonthYear, DaysPerMonth) %>%
  summarize(VolumeOrdered = n()) %>%
  mutate(DailyAverage = VolumeOrdered / DaysPerMonth) 

site_monthly_flu_volume_melt <- melt(site_monthly_flu_volume, 
                                     id.vars = c("Site", "OrderMonthYear"),
                                     measure.vars = c("VolumeOrdered", "DailyAverage"))

flu_facet_labels <- c(VolumeOrdered = "Total Ordered", DailyAverage = "Daily Average Ordered")

ggplot(data = site_monthly_flu_volume_melt, aes(x = OrderMonthYear, y = value, na.rm = TRUE)) +
  geom_line(aes(color = Site)) +
  geom_point(aes(shape = Site, color = Site)) +
  facet_grid(variable ~ ., scales = "free", labeller = labeller(variable = flu_facet_labels)) +
  labs(title = "FY2019 Flu Test Volume by Site (ED and IP)", x = "Order Month", y = "Flu Test Volume") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "right",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        panel.grid.major = element_line(color = "lightgrey"),
        panel.grid.minor = element_line(color = "lightgrey")) +
  scale_color_manual(name = "Site", values = sinai_colors[1:6]) +
  scale_x_date(date_breaks = "2 months", minor_breaks = "1 month", date_labels = "%b-%y")
  

```

### Positive Flu Tests
#### FY2019 Flu Test Volume with Positive Results (ED and IP Only)
```{r Graph percentage of positive tests}
site_test_results <- system_flu_subset %>%
  group_by(Site, OrderDate, OrderMonthYear, DaysPerMonth) %>%
  summarize(PositiveTests = sum(TestResult == "Flu Positive"),
            TotalTests = n()) %>%
  mutate(PercentPositive = PositiveTests / TotalTests * 100)

site_monthly_test_results <- site_test_results %>%
  group_by(Site, OrderMonthYear, DaysPerMonth) %>%
  summarize(PositiveTests = sum(PositiveTests),
            TotalTests = sum(TotalTests)) %>%
  mutate(DailyAverage = PositiveTests / DaysPerMonth,
         PercentPositive = PositiveTests / TotalTests * 100)

site_monthly_test_results_melt <- melt(site_monthly_test_results, id.vars = c("Site", "OrderMonthYear"),
                                       measure.vars = c("PositiveTests", "DailyAverage"))

test_results_facet <- c(PositiveTests = "Total Positive", DailyAverage = "Daily Average Positive")

ggplot(data = site_monthly_test_results_melt, aes(x = OrderMonthYear, y = value, na.rm = TRUE)) +
  geom_line(aes(color = Site)) +
  geom_point(aes(shape = Site, color = Site)) +
  facet_grid(variable ~ ., scales = "free", labeller = labeller(variable = test_results_facet)) +
  labs(title = "FY2019 Positive Flu Tests by Site (ED and IP)", x = "Order Month", y = "Flu Test Volume") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "right",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        panel.grid.major = element_line(color = "lightgrey"),
        panel.grid.minor = element_line(color = "lightgrey")) +
  scale_color_manual(name = "Site", values = sinai_colors[1:6]) +
  scale_x_date(date_breaks = "2 months", minor_breaks = "1 month", date_labels = "%b-%y")

```

### Positive Flu Admissions
Patients assumed to be admitted if patient class is Inpatient or if patient class is Emergency and ED disposition is Admit.
```{r Track positive tests that were admitted}
flu_admitted_positives <- system_flu_subset %>%
  filter(TestResult == "Flu Positive" & AdmittedIP)

site_admitted_positives <- flu_admitted_positives %>%
  group_by(Site, OrderDate, OrderMonthYear, PtClass) %>%
  summarize(Admits = n())
  
site_admitted_positives_monthly <- site_admitted_positives %>%
  group_by(Site, OrderMonthYear) %>%
  summarize(Admits = sum(Admits))

site_admitted_positives_monthly <- left_join(site_admitted_positives_monthly, 
                                             days_per_month[ , c("MonthYear", "DaysPerMonth")],
                                             by = c("OrderMonthYear" = "MonthYear"))

site_admitted_positives_monthly <- site_admitted_positives_monthly %>%
  mutate(AverageAdmissions = Admits / DaysPerMonth)

positive_admits_melt <- melt(site_admitted_positives_monthly, 
                                     id.vars = c("Site", "OrderMonthYear"),
                                     measure.vars = c("Admits", "AverageAdmissions"))

positive_admits_facet <- c(Admits = "Total Patients", AverageAdmissions = "Daily Average")

ggplot(data = positive_admits_melt, aes(x = OrderMonthYear, y = value)) +
  geom_line(aes(color = Site)) +
  geom_point(aes(shape = Site, color = Site)) +
  facet_grid(variable ~ ., scales = "free", labeller = labeller(variable = positive_admits_facet)) +
  labs(title = "FY2019 Positive Flu Tests with Admission (ED and IP)", x = "Order Month", y = "Positive Flu Tests") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "right",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        panel.grid.major = element_line(color = "lightgrey"),
        panel.grid.minor = element_line(color = "lightgrey")) +
  scale_color_manual(name = "Site", values = sinai_colors[1:6]) +
  scale_x_date(date_breaks = "2 months", minor_breaks = "1 month", date_labels = "%b-%y")


# Look at positive flu patients admitted by patient class
site_admitted_ptclass_monthly <- site_admitted_positives %>%
  group_by(Site, OrderMonthYear, PtClass) %>%
  summarize(Admits = sum(Admits))

site_admitted_ptclass_monthly_cast <- dcast(site_admitted_ptclass_monthly,
                                            Site + OrderMonthYear ~ PtClass, 
                                            value.var = "Admits")

site_admitted_ptclass_monthly_cast <- site_admitted_ptclass_monthly_cast %>%
  mutate(Emergency = ifelse(is.na(Emergency), 0, Emergency),
         Inpatient = ifelse(is.na(Inpatient), 0, Inpatient),
         Total = Emergency + Inpatient,
         PercentED = Emergency / Total * 100,
         PercentIP = Inpatient / Total  * 100)


ed_admitted_positive_monthly <- site_admitted_ptclass_monthly_cast %>%
  select(Site, OrderMonthYear, Emergency, Inpatient)

ed_admitted_positive_monthly_melt <- melt(ed_admitted_positive_monthly,
                                          id.vars = c("Site", "OrderMonthYear"),
                                          measure.vars = c("Emergency", "Inpatient"))

ed_admit_facets <- c(Emergency = "ED Patients w/ Admit Dispo", Inpatient = "Inpatient at Time of Test")

ggplot(data = ed_admitted_positive_monthly_melt, aes(x = OrderMonthYear, y = value)) +
  geom_line(aes(color = Site)) +
  geom_point(aes(shape = Site, color = Site)) +
  facet_grid(variable ~ ., scales = "free", labeller = labeller(variable = ed_admit_facets)) +
  labs(title = "FY2019 Admitted Flu Positive Patients", x = "Order Month", y = "Number of Patients") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "right",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        panel.grid.major = element_line(color = "lightgrey"),
        panel.grid.minor = element_line(color = "lightgrey")) +
  scale_color_manual(name = "Site", values = sinai_colors[1:6]) +
  scale_x_date(date_breaks = "2 months", minor_breaks = "1 month", date_labels = "%b-%y")

# ggplot(data = site_admitted_positives_ptclass_monthly, aes(x = OrderMonthYear, y = Admits)) +
#   geom_bar(aes(color = PtClass, fill = PtClass), position = "stack", stat = "identity") +
#   facet_grid(Site ~ ., scales = "free") +
#   labs(title = "FY2019 Positive Flu Tests with Admission by Patient Type", x = "Order Month", y = "Admitted Patients") +
#   theme_bw() +
#   theme(plot.title = element_text(size = 14, hjust = 0.5),
#         legend.position = "bottom",
#         legend.box = "horizontal",
#         legend.title = element_text(size = 10),
#         legend.text = element_text(size = 10),
#         axis.text.x = element_text(size = 10),
#         axis.text.y = element_text(size = 10),
#         panel.grid.major = element_line(color = "lightgrey"),
#         panel.grid.minor = element_line(color = "lightgrey")) +
#   scale_color_manual(name = "Patient Class", values = sinai_colors[1:2]) +
#   scale_fill_manual(name = "Patient Class", values = sinai_colors[1:2]) + 
#   scale_x_date(date_breaks = "2 months", minor_breaks = "1 month", date_labels = "%b-%y")

```


```{r Preprocess IP discharge data}

# Select relevant columsn and remove "I" at end of encounters for matching with Epic flu data
ip_disch_subset <- ip_disch_df_raw %>%
  select(`Encounter No`, Msmrn, `Facility Msx`,
         `Admit Type Desc Msx`, `Admit Dt Src`, `Dsch Dt Src`,
         `Icu Days Msx`, `Los No Src`) %>%
  mutate(VisitNumber = ifelse(substr(`Encounter No`, nchar(`Encounter No`), nchar(`Encounter No`)) == "I",
                              substr(`Encounter No`, 1, nchar(`Encounter No`) - 1), `Encounter No`))

# Create dataframe for crosswalking with IP data
system_flu_crosswalk <- system_flu_subset

# Remove "QB" from beginning of any MSQ encounters
system_flu_crosswalk <- system_flu_crosswalk %>%
  mutate(VisitNumber = ifelse(substr(VisitNumber, 1, 2) == "QB", substr(VisitNumber, 3, nchar(VisitNumber)),
                              VisitNumber))

# Crosswalk Epic flu data with IP discharge data based on visit number
system_test <- left_join(system_flu_crosswalk, ip_disch_subset, by = c("VisitNumber" = "VisitNumber"))

system_test$Match <- ifelse(is.na(system_test$`Encounter No`), FALSE, TRUE)

```

### Crosswalk Flu and IP Billing
*Crosswalk based on encounter number (not valid for MSBI)*
```{r Summarize positive flu patients admitted and matched}
positive_admit_pt_match_summary <- system_test %>%
  filter(TestResult == "Flu Positive" & AdmittedIP) %>%
  group_by(Site, Match) %>%
  summarize(Count = n())

positive_admit_pt_match_cast <- dcast(positive_admit_pt_match_summary, Site ~ Match, value.var = "Count")

colnames(positive_admit_pt_match_cast) <- c("Site", "VolNotMatched", "VolMatched")

positive_admit_pt_match_cast <- positive_admit_pt_match_cast %>%
  mutate(PercentNotMatched = VolNotMatched / (VolNotMatched + VolMatched) * 100,
         PercentMatched = VolMatched / (VolNotMatched + VolMatched) * 100)

# Create kable with percentage of patients believed to be admitted that are matched/not matched in IP discharge data
kable(positive_admit_pt_match_cast, format = "html", escape = FALSE, align = "c", digits = 1,
      col.names =c("Site",
                   "Volume Not Matched", "Volume Matched",
                   "% Not Matched", "% Matched"),
      caption = "Percentage of Flu Positive Admitted Patients Matched in IP Discharge Data") %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 3), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:3), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(4:5), background = sinai_colors[2], color = "white", include_thead =  TRUE) %>%
  # column_spec(column = c(5:6), background = sinai_colors[3], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(2:5), background = "inherit", color = "inherit") %>%
  collapse_rows()



```


#### Admitted Flu Patients with Inpatient Billing Data
*Crosswalk based on encounter number (not valid for MSBI)*
```{r Determine percent of admitted patients matched in IP discharge data}

system_test_summary <- system_test %>%
  group_by(Site, PtClass, AdmittedIP, Match) %>%
  summarize(Count = n())

admit_pt_match_summary <- system_test %>%
  filter(AdmittedIP) %>%
  group_by(Site, PtClass, Match) %>%
  summarize(Count = n())

admit_pt_match_cast <- dcast(admit_pt_match_summary, Site + PtClass ~ Match, value.var = "Count")

colnames(admit_pt_match_cast) <- c("Site", "PtClass", "VolNotMatched", "VolMatched")

admit_pt_match_cast <- admit_pt_match_cast %>%
  mutate(PercentNotMatched = VolNotMatched / (VolNotMatched + VolMatched) * 100,
         PercentMatched = VolMatched / (VolNotMatched + VolMatched) * 100)

# admit_pt_match_table <- admit_pt_match_cast %>%
#   select(Site, PtClass, PercentNotMatched, PercentMatched)
# 
# # Create kable with percentage of patients believed to be admitted that are matched/not matched in IP discharge data
# kable(admit_pt_match_table, format = "html", escape = FALSE, align = "c", digits = 1,
#       col.names =c("Site", "Patient Type", "% Not Matched", "% Matched"),
#       caption = "Percentage of Assumed Admitted Patients Matched in IP Discharge Data") %>%
#   kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
#   column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
#   column_spec(column = c(2:4), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
#   column_spec(column = c(2:4), background = "inherit", color = "inherit") %>%
#   collapse_rows()


# Create kable with percentage of patients believed to be admitted that are matched/not matched in IP discharge data
kable(admit_pt_match_cast, format = "html", escape = FALSE, align = "c", digits = 1,
      col.names =c("Site", "Patient Type (At Time of Test)", 
                   "Volume Not Matched", "Volume Matched",
                   "% Not Matched", "% Matched"),
      caption = "Percentage of Assumed Admitted Patients Matched in IP Discharge Data") %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(3:4), background = sinai_colors[2], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(5:6), background = sinai_colors[3], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(2:6), background = "inherit", color = "inherit") %>%
  collapse_rows()
```

#### Positive Flu Admitted Patients with Inpatient Billing Data
*Crosswalk based on encounter number (not valid for MSBI)*
```{r Determine percent of flu positive admitted patients matched in IP discharge data}
# Include patient class to understand break down
positive_admit_pt_match_summary2 <- system_test %>%
  filter(TestResult == "Flu Positive" & AdmittedIP) %>%
  group_by(Site, PtClass, Match) %>%
  summarize(Count = n())

positive_admit_pt_match_cast2 <- dcast(positive_admit_pt_match_summary2, Site + PtClass ~ Match, value.var = "Count")

colnames(positive_admit_pt_match_cast2) <- c("Site", "PtClass", "VolNotMatched", "VolMatched")

positive_admit_pt_match_cast2 <- positive_admit_pt_match_cast2 %>%
  mutate(PercentNotMatched = VolNotMatched / (VolNotMatched + VolMatched) * 100,
         PercentMatched = VolMatched / (VolNotMatched + VolMatched) * 100)

# admit_pt_match_table <- admit_pt_match_cast %>%
#   select(Site, PtClass, PercentNotMatched, PercentMatched)
# 
# # Create kable with percentage of patients believed to be admitted that are matched/not matched in IP discharge data
# kable(admit_pt_match_table, format = "html", escape = FALSE, align = "c", digits = 1,
#       col.names =c("Site", "Patient Type", "% Not Matched", "% Matched"),
#       caption = "Percentage of Assumed Admitted Patients Matched in IP Discharge Data") %>%
#   kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
#   column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
#   column_spec(column = c(2:4), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
#   column_spec(column = c(2:4), background = "inherit", color = "inherit") %>%
#   collapse_rows()


# Create kable with percentage of patients believed to be admitted that are matched/not matched in IP discharge data
kable(positive_admit_pt_match_cast2, format = "html", escape = FALSE, align = "c", digits = 1,
      col.names =c("Site", "Patient Type (At Time of Test)", 
                   "Volume Not Matched", "Volume Matched",
                   "% Not Matched", "% Matched"),
      caption = "Percentage of Flu Positive Admitted Patients Matched in IP Discharge Data") %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(3:4), background = sinai_colors[2], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(5:6), background = sinai_colors[3], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(2:6), background = "inherit", color = "inherit") %>%
  collapse_rows()

```




```{r Test code to search by MRN and compare test date to admit and discharge dates}
# 
# # Create a dataframe with matched encounters
# matched_df <- system_test %>%
#   filter(!is.na(`Encounter No`))
# 
# # Create a dataframe with un-matched encounters
# test_df <- system_test %>%
#   filter(is.na(`Encounter No`))
# 
# test_df_copy <- system_test %>%
#   filter(is.na(`Encounter No`))
# 
# for(k in 1:nrow(test_df)) {
#   mrn_df <- NULL
#   # print(k)
#   if(test_df$MRN[k] %in% ip_disch_subset$Msmrn) {
#     # Determine if test date is within 1 day of admit date and before discharge
#     mrn_df <- ip_disch_subset %>%
#       filter(Msmrn == test_df$MRN[k]) %>%
#       arrange(`Admit Dt Src`) %>%
#       mutate(TestWithinStay = (test_df$OrderDate[k] >= (`Admit Dt Src` - 1) 
#                                & test_df$OrderDate[k] <= `Dsch Dt Src`), )
#     # print(paste0("MRN Matches: ", nrow(mrn_df)))
#     
#     matches <- mrn_df[mrn_df$TestWithinStay, ]
#     
#     # print(paste0("Test within stay: ", nrow(matches)))
#     if(nrow(matches) != 0) {
#       test_df[k, c("Encounter No", "Msmrn", "Facility Msx", 
#                    "Admit Type Desc Msx", "Admit Dt Src", "Dsch Dt Src",
#                    "Icu Days Msx", "Los No Src")] <- 
#         matches[1, c("Encounter No", "Msmrn", "Facility Msx", 
#                      "Admit Type Desc Msx", "Admit Dt Src", "Dsch Dt Src",
#                      "Icu Days Msx", "Los No Src")]
#         
#     }
# 
#     } else {
#     test_df[k, ] <- test_df[k, ]
#   }
# }
# 
# test_df_summary <- test_df %>%
#   group_by(Site, PtClass, TestResult, AdmittedIP) %>%
#   summarize(StillNotMatched = sum(is.na(`Encounter No`)),
#             NowMatched = sum(!is.na(`Encounter No`)))

```
