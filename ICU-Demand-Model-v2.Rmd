---
title: "Adult Med Surg Critical Care Demand"
author: "HSO"
date: "5/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r Install and load packages}
# Code for analyzing historical COVID-19 IP census, admissions, and discharges ----------------------

#Install and load necessary packages --------------------
#install.packages("readraw_dfl")
#install.packages("writeraw_dfl")
#install.packages("ggplot2")
#install.packages("lubridate")
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("svDialogs")
#install.packages("stringr")
#install.packages("formattable")
# install.packages("ggpubr")
# install.packages("rprojroot")

# Load libraries ------------------------
library(readxl)
library(writexl)
library(ggplot2)
library(lubridate)
library(dplyr)
library(reshape2)
library(svDialogs)
library(stringr)
library(formattable)
library(scales)
library(reshape2)
library(knitr)
library(rmarkdown)
library(kableExtra)

```

```{r Determine drive mapping}
rm(list = ls())

if (list.files("J://") == "Presidents") {
  user_directory <- "J:/Presidents/HSPI-PM/Operations Analytics and Optimization/Projects/System Operations/COVID Scenario Testing"
} else {
  user_directory <- "J:/deans/Presidents/HSPI-PM/Operations Analytics and Optimization/Projects/System Operations/COVID Scenario Testing"
}

```


```{r Import raw data}
# Set working directory and select raw data ----------------------------

covid_trend_start_date <- as.Date("3/12/20", format = "%m/%d/%y")

covid_steady_state_start <- as.Date("5/15/20", format = "%m/%d/%y")
covid_steady_state_end <- as.Date("5/31/20", format = "%m/%d/%y")

sinai_colors <- c("#221f72", "#00AEEF", "#D80B8C", "#4C4D4C", "#8988dd", "#B2B3B2", "#F887CE")

site_order <- c("MSH", "MSQ", "MSB", "MSBI", "MSM", "MSW", "MSHS")

flu_season_order <- c("Non-Flu", "Flu")

# Import data tables from DataMart ---------------
# covid_ip_days_df_raw <- read.csv(paste0(user_directory, "/DataMart/COVID_IP_PATIENT_DAYS_DETAIL_202006091548.csv"), stringsAsFactors = FALSE, na = c("", "NA"))
covid_ip_days_df_raw <- read.csv(paste0(user_directory, "/DataMart/COVID_IP_PATIENT_DAYS_DETAIL_202006151700.csv"), stringsAsFactors = FALSE, na = c("", "NA"))


# Import Epic daily COVID census
epic_covid_census_raw <- read_excel(paste0(user_directory, "/Epic COVID Repo/COVID MRN Daily Census Export 2020-06-08.xlsx"))

# Import FY2019 IP discharge data
ip_disch_df_raw <- read_excel(paste0(user_directory, "/IP Discharge Data/IP Disch FY2019 2020-05-13.xlsx"), na = c("", "NA"),
                                col_types = c("text", "text", "text", "text", "date", "date", "date",
                                              "text", "text", "text", "text", "text", "text", "text",
                                              "numeric", "numeric"))

# Import FY2019 IP census room & board charge data
rb_charge_df_raw <- read_excel(paste0(user_directory, "/IP Discharge Data/IP R&B Charges Jan19 to Feb20 w Accom Code 2020-06-11.xlsx"), 
                               na = c("", "NA"), 
                               col_type = c("text", "text", "text", "text", "text", "text", "text", "date", "numeric"))
# 
# Import analysis reference
reference_file <- paste0(user_directory, "/IP Discharge Data/Analysis Reference 2020-06-11.xlsx")
ref_sheets <- excel_sheets(reference_file)

ref_data <- lapply(ref_sheets, function(x) read_excel(reference_file, sheet = x))

site_ref <- ref_data[[1]]
dispo_ref <- ref_data[[2]]
service_line_ref <- ref_data[[3]]
ip_disch_units_ref <- ref_data[[4]]

rb_charge_ipd_ref <- ref_data[[5]]
rb_charge_site_ref <- ref_data[[6]]
rb_charge_accom_ref <- ref_data[[7]]

```


```{r Format COVID IP days raw data}
# Format inpatient days dataframe ----------------------------------
dm_covid_days_df <- covid_ip_days_df_raw

# Remove duplicates
dm_covid_days_df <- unique(dm_covid_days_df)

# Convert dates from characters to dates
dm_covid_days_df <- dm_covid_days_df %>%
  mutate(CENSUS_DATE = as_datetime(CENSUS_DATE, tz = "America/New_York"),
         ADMIT_DATE = as_datetime(ADMIT_DATE, tz = "America/New_York"),
         DSCH_DATE = as_datetime(DSCH_DATE, tz = "America/New_York"))

# Create columns with census, admit, and discharge dates
dm_covid_days_df <- dm_covid_days_df %>%
  mutate(CensusDate = date(CENSUS_DATE),
         AdmitDate = date(ADMIT_DATE),
         DischDate = date(DSCH_DATE))

# Determine if patient day is an ICU day based on site specific criteria and determine if patient is a COVID patient -----------
# MSQ ICU timeline (provided by A. Dempsey on 5/22/20; updated start date of 3/28/20 provided on 6/1/20)
# 3/28/20-5/6/20:
# 5 East - PACU to ICU - 14 beds
# 6 East - IMCU to ICU - 11 beds
# 6 ICU - ICU - 8 beds

# 5/7/20 - 5/19/20:
# 5 East - back to PACU - 0 beds
# 2 East Rooms 208-217 convert to ICU
# 6 East - IMCU to ICU - 11 beds
# 6 ICU - ICU - 8 beds

# 5/22/20 onward:
# 5 East - back to PACU - 0 beds
# 2 East - back to M/S - 0 beds
# 6 East - 3 IMCU rooms 601, 606, and 608 convert to IMCU - 8 beds
# 6 ICU - ICU - 8 beds

# MSSN: Any bed type defined as critical care or critical care surge
# Other sites: Accommodation code of intensive care or coronary care
# COVID cohort COVID_FLAGS: Positive, PUI, Susc, and Resolved
dm_covid_days_df <- dm_covid_days_df %>%
  mutate(DataMartICUDay = (IP_SITE == "MSSN" & (CENSUS_BED_TYPE %in% "Critical Care" | CENSUS_BED_TYPE %in% "Critical Care Surge")) |
           (IP_SITE != "MSSN" & IP_SITE != "MSQ" & (ACCOMMODATION_DESC %in% "INTENSIVE CARE" | ACCOMMODATION_DESC %in% "CORONARY CARE")) | (IP_SITE == "MSQ" & (CENSUS_DEPT == "MSQ 6 ICU" |
                                                                                                                                                                  (CensusDate >= as.Date("3/28/20", format = "%m/%d/%y") & CensusDate <= as.Date("5/6/20", format = "%m/%d/%y") & CENSUS_DEPT == "MSQ 5 EAST") |
                                                                                                                                                                  (CensusDate >= as.Date("5/7/20", format = "%m/%d/%y") & CensusDate <= as.Date("5/19/20", format = "%m/%d/%y") & CENSUS_DEPT == "MSQ 2 EAST" & CENSUS_ROOM %in% as.character(c(208:217))) |
                                                                                                                                                                  (CensusDate >= as.Date("3/28/20", format = "%m/%d/%y") & CensusDate < as.Date("5/22/20", format = "%m/%d/%y") & CENSUS_DEPT == "MSQ 6 EAST") |
                                                                                                                                                                  (CensusDate >= as.Date("5/22/20", format = "%m/%d/%y") & CENSUS_DEPT == "MSQ 6 EAST" & CENSUS_ROOM %in% as.character(c(601, 606, 608)) == FALSE))),
         
         COVIDPt = (COVID_FLAG %in% c("COVID-POSITIVE", "COVID-PUI", "COVID-SUSC", "COVID-RESOLVED")))


# Subset data frame based on census date and remove MSSN
dm_covid_census_subset <- dm_covid_days_df %>%
  filter(IP_SITE != "MSSN" & COVIDPt & CensusDate >= covid_trend_start_date) %>%
  select(IP_SITE, CSN, MRN, 
         AdmitDate, DischDate, CensusDate, IN_HOUSE, 
         COVID_FLAG, 
         CENSUS_DEPT, CENSUS_ROOM, ACCOMMODATION_DESC, 
         PATIENT_DAY, ICU_DAY, VENT_DAY, VENT_NON_ICU, TOT_CRITICAL_CARE,
         DataMartICUDay, LOAD_DATE, INFECTION_STATUS) %>%
  mutate(DataMartInfection = INFECTION_STATUS)

dm_covid_census_subset$INFECTION_STATUS <- NULL

```


```{r Format Epic COVID census data}
epic_covid_census <- epic_covid_census_raw

epic_covid_census <- epic_covid_census %>%
  mutate(Encounter = as.character(PAT_ENC_CSN_ID), 
         EpicInfection = INFECTION_STATUS, 
         CensusDate = date(CENSUS_DATE),
         Site = ifelse(LOC_NAME == "MOUNT SINAI BI BROOKLYN", "MSB",
                       ifelse(LOC_NAME == "THE MOUNT SINAI HOSPITAL" | LOC_NAME == "MS 1160 5TH AVE", "MSH",
                              ifelse(LOC_NAME == "MOUNT SINAI QUEENS HOSPITAL", "MSQ", 
                                     ifelse(LOC_NAME == "MOUNT SINAI WEST", "MSW", 
                                            ifelse(LOC_NAME == "MOUNT SINAI ST. LUKE'S", "MSM", NA))))),
         # Determine if census day was also an ICU day using same logic as above
         EpicICUDay = (Site != "MSQ" & (ACCOMMODATION_CODE %in% "Intensive Care" | ACCOMMODATION_CODE %in% "Coronary Care")) | (Site == "MSQ" & (DEPARTMENT_NAME == "MSQ 6 ICU" |
                                                                                                                                                                  (CensusDate >= as.Date("3/28/20", format = "%m/%d/%y") & CensusDate <= as.Date("5/6/20", format = "%m/%d/%y") & DEPARTMENT_NAME == "MSQ 5 EAST") |
                                                                                                                                                                  (CensusDate >= as.Date("5/7/20", format = "%m/%d/%y") & CensusDate <= as.Date("5/19/20", format = "%m/%d/%y") & DEPARTMENT_NAME == "MSQ 2 EAST" & ROOM_NAME %in% as.character(c(208:217))) |
                                                                                                                                                                  (CensusDate >= as.Date("3/28/20", format = "%m/%d/%y") & CensusDate < as.Date("5/22/20", format = "%m/%d/%y") & DEPARTMENT_NAME == "MSQ 6 EAST") |
                                                                                                                                                                  (CensusDate >= as.Date("5/22/20", format = "%m/%d/%y") & DEPARTMENT_NAME == "MSQ 6 EAST" & ROOM_NAME %in% as.character(c(601, 606, 608)) == FALSE))),
         # Create a flag for COVID census day
         COVIDDay = 1,
         # Determine if census department is an ED or Psych ED to remove later
         ED_Loc = str_detect(DEPARTMENT_NAME, "(EMERGENCY)|(PSYCH ED)"))

# Subset Epic census data to include non-ED locations and selected columns
epic_covid_census_subset <- epic_covid_census %>%
  filter(ED_Loc == FALSE) %>%
  select(Site, MRN, Encounter, CensusDate,
         DEPARTMENT_NAME, EpicInfection, 
         GROUP, `SERVICE GROUPER`, BED_USE, ACCOMMODATION_CODE,
         EpicICUDay, COVIDDay)


```

```{r Crosswalk Epic and DataMart data to pull in ICU and vent logic}
epic_site_covid_crosswalk <- left_join(epic_covid_census_subset, dm_covid_census_subset,
                                    by = c("Encounter" = "CSN", "CensusDate" = "CensusDate"))

# epic_site_covid_crosswalk$Test <- duplicated(epic_site_covid_crosswalk[ , c("Encounter", "CensusDate")])
# 
# dm_covid_census_subset$Test <- duplicated(dm_covid_census_subset[ , c("CSN", "CensusDate")])

# Filter data based on census dates present in Epic and DataMart
epic_site_covid_crosswalk <- epic_site_covid_crosswalk %>%
  filter(CensusDate <= min(max(epic_site_covid_crosswalk$CensusDate),
                           max(dm_covid_census_subset$CensusDate)))

# Determine if census day was a critical care day
epic_site_covid_crosswalk$DataMartICUDay[is.na(epic_site_covid_crosswalk$DataMartICUDay)] <- FALSE

epic_site_covid_crosswalk <- epic_site_covid_crosswalk %>%
  mutate(ICUMaster = ifelse(DataMartICUDay | EpicICUDay, 1, 0),
         VentNonICU = ifelse(VENT_NON_ICU %in% 1 & ICUMaster %in% 0, 1, 0),
         CriticalCareDay = ifelse(ICUMaster %in% 1 | VentNonICU %in% 1, 1, 0))

```

```{r Create MSBI daily census using DataMart}
msbi_covid_census <- dm_covid_census_subset %>%
  filter(IP_SITE == "MSBI" & 
           CensusDate <= min(max(epic_site_covid_crosswalk$CensusDate),
                           max(dm_covid_census_subset$CensusDate)))

# Create a dataframe to mimic Epic crosswalk dataframe
msbi_epic_mimic_covid <- msbi_covid_census %>%
  mutate(Site = "MSBI",
         MRN.x = MRN,
         MRN.y = MRN,
         MRN = NULL,
         Encounter = CSN,
         DEPARTMENT_NAME = NA,
         EpicInfection = NA,
         GROUP = NA,
         `SERVICE GROUPER` = NA,
         BED_USE = NA,
         ACCOMMODATION_CODE = NA,
         EpicICUDay = FALSE,
         COVIDDay = 1,
         ICUMaster = ifelse(DataMartICUDay | EpicICUDay, 1, 0),
         VentNonICU = ifelse(VENT_NON_ICU %in% 1 & ICUMaster %in% 0, 1, 0),
         CriticalCareDay = ifelse(ICUMaster %in% 1 | VentNonICU %in% 1, 1, 0))

epic_col_names <- colnames(epic_site_covid_crosswalk)

msbi_epic_mimic_covid<- msbi_epic_mimic_covid[ , epic_col_names]

```

```{r Combine data for Epic sites and MSBI and create daily census dataframe}
all_sites_covid_enc <- rbind(epic_site_covid_crosswalk, msbi_epic_mimic_covid)

# Create daily COVID census, ICU day, vent days, and critical care days by site
daily_covid_census_site <- all_sites_covid_enc %>%
  group_by(Site, CensusDate) %>%
  summarize(COVIDCensus = n(),
            DMICUCensus = sum(DataMartICUDay, na.rm = TRUE),
            EpicICUCensus = sum(EpicICUDay, na.rm = TRUE), 
            ICUCensus = sum(ICUMaster, na.rm = TRUE), 
            VentNonICUCensus = sum(VentNonICU, na.rm = TRUE), 
            CriticalCareCensus = sum(CriticalCareDay, na.rm = TRUE)) %>%
  ungroup()

# Create daily COVID census, ICU day, vent days, and critical care days across system
daily_covid_census_system <- all_sites_covid_enc %>%
  group_by(CensusDate) %>%
  summarize(Site = "MSHS",
            COVIDCensus = n(),
            DMICUCensus = sum(DataMartICUDay, na.rm = TRUE),
            EpicICUCensus = sum(EpicICUDay, na.rm = TRUE), 
            ICUCensus = sum(ICUMaster, na.rm = TRUE), 
            VentNonICUCensus = sum(VentNonICU, na.rm = TRUE), 
            CriticalCareCensus = sum(CriticalCareDay, na.rm = TRUE)) %>%
  ungroup()

daily_covid_census_system <- daily_covid_census_system[ , colnames(daily_covid_census_site)]

# Bind together site and system daily census
daily_covid_census_summary <- rbind(daily_covid_census_site, daily_covid_census_system)



```


```{r Determine dates of peak IP and ICU census}
# Compare ICU census using 2 methods - date with peak IP COVID census and date with peak critical care COVID census

covid_census_peaks <- daily_covid_census_summary %>%
  group_by(Site) %>%
  summarize(PeakIPCensusDate = CensusDate[which.max(COVIDCensus)],
            PeakIPCensus = COVIDCensus[which.max(COVIDCensus)],
            PeakIPICUCensus = ICUCensus[which.max(COVIDCensus)],
            PeakIPVentNonICUCensus = VentNonICUCensus[which.max(COVIDCensus)],
            PeakIPCCCensus = CriticalCareCensus[which.max(COVIDCensus)],
            
            PeakCCCensusDate = CensusDate[which.max(CriticalCareCensus)],
            PeakCCIPCensus = COVIDCensus[which.max(CriticalCareCensus)],
            PeakCCICUCensus = ICUCensus[which.max(CriticalCareCensus)],
            PeakCCVentNonICUCensus = VentNonICUCensus[which.max(CriticalCareCensus)],
            PeakCCCensus = CriticalCareCensus[which.max(CriticalCareCensus)])

covid_census_peaks$Site <- factor(covid_census_peaks$Site, levels = site_order, ordered = TRUE)

covid_census_peaks <- covid_census_peaks %>%
  arrange(Site)

# Moving forward, use date with highest critical care census for scenario modeling over highest IP census

covid_census_icu_peak_summary <- covid_census_peaks[ , c("Site", "PeakCCCensusDate",
                                                         "PeakCCIPCensus", "PeakCCICUCensus",
                                                         "PeakCCVentNonICUCensus", "PeakCCCensus")]
colnames(covid_census_icu_peak_summary) <- c("Site", "Date", "IPCensus", 
                                             "ICUCensus", "VentNonICUCensus", "CriticalCareCensus")

```

```{r Determine steady state COVID census}
covid_census_steady_state <- daily_covid_census_summary %>%
  filter(CensusDate >= covid_steady_state_start) %>%
  group_by(Site) %>%
  summarize(IPADC = mean(COVIDCensus),
            ICUADC = mean(ICUCensus),
            VentNonICUADC = mean(VentNonICUCensus),
            CriticalCareADC = mean(CriticalCareCensus))

covid_census_steady_state$Site <- factor(covid_census_steady_state$Site, level = site_order, ordered = TRUE)

```


```{r Format IP discharge data}
# Format inpatient days dataframe ----------------------------------
ip_disch_df <- ip_disch_df_raw

# Create columns with census, admit, and discharge dates
ip_disch_df <- ip_disch_df %>%
  mutate(AdmitDate = date(`Admit Dt Src`),
         DischDate = date(`Dsch Dt Src`),
         AdmitMonth = month(AdmitDate),
         DischMonth = month(DischDate))


# Determine admit source
ip_disch_df <- ip_disch_df %>%
  mutate(AdmitType = ifelse(is.na(`Admit Type Desc Msx`) | str_detect(`Admit Type Desc Msx`, "(INFORMATION NOT AVAILABLE)"), "NonElective",
                            ifelse(str_detect(`Admit Type Desc Msx`, "ELECTIVE"), "Elective",
                            ifelse(str_detect(`Admit Type Desc Msx`, "NEWBORN"), "Newborn",
                                   ifelse(str_detect(`Admit Type Desc Msx`, "(EMERGENCY)|(URGENT)"), "NonElective", "Other")))))

# Crosswalk raw data with reference data -------------------------
# Crosswalk sites
ip_disch_df <- left_join(ip_disch_df, site_ref, by = c("Facility Msx" = "Facility Msx"))

# Crosswalk service lines to include/exclude
ip_disch_df <- left_join(ip_disch_df, service_line_ref[ , c("Service Desc Msx", "ServiceInclude")], by = c("Service Desc Msx" = "Service Desc Msx"))

# If no discharge unit present, set to "Unknown"
ip_disch_df[is.na(ip_disch_df$`Unit Desc Msx`), "Unit Desc Msx"] <- "Unknown"

# Crosswalk unit to determine if it is an ICU, peds unit, nursery/NICU,
ip_disch_df <- left_join(ip_disch_df, ip_disch_units_ref, by = c("Site" = "Site", "Unit Desc Msx" = "Unit Desc Msx"))


```

```{r Susbet data frame based on unit and patient type and then summarize}
# # Inclusion criteria
# # Remove any peds encounters
# # Remove NICU and newborn discharges
# # Include any encounter with an ICU LOS > 0 OR any patient discharged from an adult med/surg unit
# ip_disch_subset <- ip_disch_df %>%

#   filter(PedsUnit == "No" & NurseryNICU == "No" & AdmitType != "Newborn" & (`Icu Days Msx` > 0 | AdultMedSurg == "Yes"))

# Exclusion criteria
# Remove any chem dependency, psych, rehab, peds, newborn, neonatal, and OB encounters
# Remove any encounter with "Newborn" as admit type
ip_disch_subset <- ip_disch_df %>%
  filter(ServiceInclude == "Yes" & AdmitType != "Newborn")

# Determine total discharges and ICU ADC for each site based on admit type ----------------------------
# Summarize data for each site based on admit type
ip_disch_admit_type_site_level <- ip_disch_subset %>%
  group_by(Site, AdmitType) %>%
  summarize(VolDisch = n(),
            ICUDays = sum(`Icu Days Msx`)) %>%
  ungroup()

# Summarize data for each site across all admit types
ip_disch_all_admits_site <- ip_disch_subset %>%
  group_by(Site) %>%
  summarize(AdmitType = "All",
            VolDisch = n(),
            ICUDays = sum(`Icu Days Msx`)) %>%
  ungroup()

# Bind data together
ip_disch_site_summary <- rbind(ip_disch_admit_type_site_level, ip_disch_all_admits_site)
ip_disch_site_summary <- ip_disch_site_summary[order(ip_disch_site_summary$Site), ]

# Determine total discharges and ICU ADC for system based on admit type -----------------------------
# Summarize data for each site based on admit type
ip_disch_admit_type_system <- ip_disch_subset %>%
  group_by(AdmitType) %>%
  summarize(Site = "MSHS",
            VolDisch = n(),
            ICUDays = sum(`Icu Days Msx`)) %>%
  ungroup()

ip_disch_admit_type_system <- ip_disch_admit_type_system[ , c("Site", "AdmitType", "VolDisch", "ICUDays")]

# Summarize data for each site across all admit types
ip_disch_all_admits_system <- ip_disch_subset %>%
  summarize(Site = "MSHS",
            AdmitType = "All",
            VolDisch = n(),
            ICUDays = sum(`Icu Days Msx`)) %>%
  ungroup()

# Bind data together
ip_disch_system_summary <- rbind(ip_disch_admit_type_system, ip_disch_all_admits_system)

# Calculate ICU ADC for each site and system
ip_disch_site_summary <- ip_disch_site_summary %>%
  mutate(ICUADC = ICUDays / 365)

ip_disch_system_summary <- ip_disch_system_summary %>%
  mutate(ICUADC = ICUDays / 365)

# Bind site and system level data
ip_disch_summary <- rbind(ip_disch_site_summary, ip_disch_system_summary)

# Melt data frame to calculate percentage of elective and non-elective discharges ----------------------
ip_disch_admit_type_percent <- dcast(ip_disch_summary[ , c("Site", "AdmitType", "VolDisch")],
                                  Site ~ AdmitType, value.var = "VolDisch")

ip_disch_admit_type_percent <- ip_disch_admit_type_percent %>%
  mutate(Elective = Elective / All * 100, NonElective = NonElective / All * 100, All = All / All * 100)

ip_disch_admit_type_percent <- melt(ip_disch_admit_type_percent, id.vars = "Site", variable.name = "AdmitType", value.name = "DischPerc")

ip_disch_admit_type_percent$AdmitType <- as.character(ip_disch_admit_type_percent$AdmitType)

# Bind with summary stats table
ip_disch_summary <- left_join(ip_disch_summary, ip_disch_admit_type_percent, by = c("Site" = "Site", "AdmitType" = "AdmitType"))

ip_disch_summary <- ip_disch_summary[ , c("Site", "AdmitType",
                                          "VolDisch", "DischPerc",
                                          "ICUDays", "ICUADC")]


```

```{r Scale peak COVID IP census data}

# Scale ICU census at peak
# scale_factors <- data.frame("Scale" = c(0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.8, 0.9, 1.0))
scale_factors_covid <- data.frame("Scale" = c(0.25, 0.5, 0.75, 1.0))

# Calculate peak COVID scenarios using the difference between peak census and steady state census
# covid_icu_scenarios <- covid_census_icu_peak_summary %>%
#   select(Site, CriticalCareCensus)
covid_icu_peak_scenarios <- covid_census_icu_peak_summary %>%
  mutate(PeakIPCensus = IPCensus,
          PeakCriticalCareCensus = CriticalCareCensus) %>%
  select(Site, Date, PeakIPCensus, PeakCriticalCareCensus)

covid_steady_state_subtract <- covid_census_steady_state %>%
  mutate(SSIPADC = IPADC,
         SSCriticalCareADC = CriticalCareADC) %>%
  select(Site, SSIPADC, SSCriticalCareADC)

covid_icu_scenarios <- left_join(covid_icu_peak_scenarios,
                                 covid_steady_state_subtract,
                                  by = c("Site" = "Site"))

covid_icu_scenarios <- covid_icu_scenarios %>%
  mutate(PeakBeyondSSIPADC = PeakIPCensus - SSIPADC,
         PeakBeyondSSCriticalCareADC = PeakCriticalCareCensus - SSCriticalCareADC)

covid_icu_scenarios[ , c("SSIPADC", "SSCriticalCareADC")] <- NULL

covid_icu_scenarios <- melt(covid_icu_scenarios, id.vars = c("Site", "Date"),
                            measure.vars = c("PeakIPCensus", "PeakCriticalCareCensus",
                                             "PeakBeyondSSIPADC", "PeakBeyondSSCriticalCareADC"))

covid_icu_scenarios <- covid_icu_scenarios %>%
  mutate(Scenario = ifelse(variable == "PeakIPCensus" | variable == "PeakCriticalCareCensus", 
                           "COVID Peak", "COVID Peak Beyond Steady State"),
         CensusType = ifelse(variable == "PeakIPCensus" | variable == "PeakBeyondSSIPADC", "IPADC", "CriticalCareADC"),
         Date = as_date(ifelse(Scenario == "COVID Peak", Date, NA)))

covid_icu_scenarios$variable <- NULL

covid_icu_scenarios <- dcast(covid_icu_scenarios, Site + Scenario + Date ~ CensusType, 
                             value.var = "value")

covid_icu_scenarios <- covid_icu_scenarios %>%
  arrange(Scenario, Site)

scale_length_covid <- nrow(scale_factors_covid)
covid_icu_length <- nrow(covid_icu_scenarios)

# Replicate data frames
scale_factors_covid <- (scale_factors_covid[rep(rownames(scale_factors_covid), covid_icu_length), ])
scale_factors_covid <- data.frame("Scale" = scale_factors_covid)

scale_factors_covid <- scale_factors_covid[order(scale_factors_covid$Scale), ]

covid_icu_scenarios_scale <- covid_icu_scenarios[rep(rownames(covid_icu_scenarios), scale_length_covid), ]
covid_icu_scenarios_scale = cbind(covid_icu_scenarios_scale, Scale = scale_factors_covid)

# Calculate census for different scenarios based on historical data and scale
covid_icu_scenarios_scale <- covid_icu_scenarios_scale %>%
  mutate(ScaledICUCensus = ifelse(Scenario == "COVID Peak", NA, CriticalCareADC * Scale),
         ScaleName = paste0(Scale*100, "% Peak"))

# Set site and scale name to factors before casting
covid_icu_scenarios_scale$ScaleName <- factor(covid_icu_scenarios_scale$ScaleName,
                                   levels = c("25% Peak", "50% Peak", "75% Peak", "100% Peak"), ordered = TRUE)

# Format casted dataframe to italicize and grey out NAs
covid_icu_scenarios_scale_kable <- covid_icu_scenarios_scale %>%
    mutate(Date = cell_spec(Date, format = "html", italic = ifelse(is.na(Date), TRUE, FALSE),
                            color = ifelse(is.na(Date), "lightgrey", "black")),
           ScaledICUCensus = cell_spec(round(ScaledICUCensus, 1), italic = ifelse(is.na(ScaledICUCensus), TRUE, FALSE),
                            color = ifelse(is.na(ScaledICUCensus), "lightgrey", "black")))


# Cast data frame for kables
covid_icu_scenarios_cast <-  dcast(covid_icu_scenarios_scale_kable, Site + Scenario + Date + IPADC + CriticalCareADC ~ ScaleName, value.var = "ScaledICUCensus")

```

```{r Scale historical ICU ADC data}

# Scale ICU census at peak
# scale_factors <- data.frame("Scale" = c(0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.8, 0.9, 1.0))
scale_factors_ip_adc <- data.frame("Scale" = c(0.25, 0.5, 0.75, 1.0))

# Subset ICU data
ip_icu_scenarios <- ip_disch_summary %>%
  select(Site, ICUADC)

scale_length <- nrow(scale_factors_ip_adc)
ip_icu_length <- nrow(ip_icu_scenarios)

# Replicate data frames
scale_factors_ip_icu <- (scale_factors_ip_adc[rep(rownames(scale_factors_ip_adc), ip_icu_length), ])
scale_factors_ip_icu <- data.frame("Scale" = scale_factors_ip_icu)

scale_factors_ip_icu <- scale_factors_ip_icu[order(scale_factors_ip_icu$Scale), ]

ip_icu_scenarios <- ip_icu_scenarios[rep(rownames(ip_icu_scenarios), scale_length), ]
ip_icu_scenarios = cbind(ip_icu_scenarios, Scale = scale_factors_ip_icu)

# Calculate census for different scenarios based on historical data and scale
ip_icu_scenarios <- ip_icu_scenarios %>%
  mutate(ScaledICUCensus = ICUADC * Scale,
         ScaleName = paste0(Scale*100, "% Historical"))

# Set site and scale name to factors before casting
ip_icu_scenarios$Site <- factor(ip_icu_scenarios$Site, levels = c("MSH", "MSQ", "MSB", "MSBI", "MSW", "MSM", "MSHS"), ordered = TRUE)

ip_icu_scenarios$ScaleName <- factor(ip_icu_scenarios$ScaleName,
                                   levels = c("25% Historical", "50% Historical", "75% Historical", "100% Historical"), ordered = TRUE)

# Cast data frame for kables
ip_icu_scenarios_cast <-  dcast(ip_icu_scenarios, Site + ICUADC ~ ScaleName, value.var = "ScaledICUCensus")
ip_icu_scenarios_cast$Site <- as.character(ip_icu_scenarios_cast$Site)

# Bind ICU ADC scenarios with IP discharge summary table
ip_disch_summary_scenarios <- left_join(ip_disch_summary, ip_icu_scenarios_cast, by = c("Site" = "Site", "ICUADC" = "ICUADC"))

```

```{r Custom function for creating IP ICU projection table}
icu_census_project <- function(site) {
  site <- site

  ip_icu_scenarios_site <- ip_disch_summary_scenarios %>%
    filter(Site == site)

  ip_icu_scenarios_site$Site <- NULL

  kable(ip_icu_scenarios_site, format = "html", escape = FALSE, align = "c", digits = 1,
      col.names =c("Admit Type", "# Discharges", "% Discharges", "ICU Days", "ICU ADC",
                   "25% Historical", "50% Historical", "75% Historical", "100% Historical"),
      caption = paste(site, " ICU Census Scenarios (Based on FY2019 Data)")) %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 5), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:5), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(6:9), background = sinai_colors[2], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(2:9), background = "inherit", color = "inherit") %>%  
  # row_spec(row = 0, background = "#221f72", color = "white") %>%
  row_spec(row = nrow(ip_icu_scenarios_site), background = "lightgrey", bold = T) %>%
  add_header_above(c(" " = 1, "FY2019 Discharges" = 4, "ICU Census Scenarios" = 4), background = c("", sinai_colors[1], sinai_colors[2]), color = "white", line = FALSE)

}


```

```{r Custom function for creating COVID-19 projection table}
covid_census_project <- function(site) {
  site <- site

  # covid_disch_scenarios_site <- covid_census_peak_summary_scenarios %>%
  #   filter(Site == site)
  # 
  # covid_disch_scenarios_site$Site <- NULL
  
  covid_disch_scenarios_site <- covid_icu_scenarios_cast %>%
    filter(Site == site)

  covid_disch_scenarios_site$Site <- NULL
  
  kable(covid_disch_scenarios_site, format = "html", escape = FALSE, align = "c", digits = 1,
      col.names =c("Scenario", "Date", "IP Census", "Critical Care Census", 
                   "25% Peak", "50% Peak", "75% Peak", "100% Peak"),
      caption = paste(site, " COVID-19 Critical Care Census Scenarios")) %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 4), border_right = "thin solid lightgray") %>%
  column_spec(column = c(1:4), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(5:8), background = sinai_colors[2], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(1:8), background = "inherit", color = "inherit") %>%
  # row_spec(row = 0, background = "#221f72", color = "white") %>%
  add_header_above(c("COVID-19 Peak Critical Care Census" = 4, "COVID-19 Critical Care Census Scenarios" = 4), background = c(sinai_colors[1], sinai_colors[2]), color = "white", line = FALSE)
}

```

```{r Preprocess room and board data to determine daily census changes during flu season}
rb_charge_df <- rb_charge_df_raw

# Crosswalk sites, unit, and accommodation code reference data
rb_charge_df <- left_join(rb_charge_df, rb_charge_site_ref, by = c("Hospital" = "Hospital"))

rb_charge_df <- left_join(rb_charge_df, rb_charge_ipd_ref, by = c("Site" = "Site", "IPD" = "IPD"))

rb_charge_df <- left_join(rb_charge_df, rb_charge_accom_ref, by = c("IPD" = "IPD", "Accommodation Description" = "Accommodation Description"))

# Master roll up for ICU based on unit mapping and accommodation code
rb_charge_df <- rb_charge_df %>%
  mutate(ICUMaster = ifelse(ICU == "Depends", ICUAccom, ICU))

# Create columns for census date, month, and year. Include days per month and whether or not the
# census date is in a peak flu month (Nov-Mar)
rb_charge_df <- rb_charge_df %>%
  mutate(CensusDate = date(`Service Date`), 
         CensusMonth = month(CensusDate),
         CensusYear = year(CensusDate),
         DaysInMonth = days_in_month(CensusDate),
         FluMonth = ifelse(CensusMonth <= 3 | CensusMonth >= 11, 1, 0))

# Subset R&B data for adult med surg units only
adult_med_surg_df <- rb_charge_df %>%
  filter(AdultMedSurg == "Yes") %>%
  select(`Encounter Number`, Msmrn, Hospital, Site,
         `Service Date`, CensusDate, CensusMonth, CensusYear, DaysInMonth, FluMonth,
         IPD, `Accommodation Description`, ICU, AdultMedSurg, PedsUnit, NurseryNICU,
         ICUAccom, ICUMaster)
```

```{r Determine IP and ICU ADC to understand flu surges}
# Summarize daily adult med surg census by site
ms_daily_census_site <- adult_med_surg_df %>%
  group_by(Site, CensusDate, CensusMonth, CensusYear, DaysInMonth, FluMonth) %>%
  summarize(IPDays = n(), ICUDays = sum(ICUMaster == "Yes"))

# Summarize 2019 monthly adult med surg census by site
ms_monthly_census_site <- adult_med_surg_df %>%
  filter(CensusYear == 2019) %>%
  group_by(Site, CensusYear, CensusMonth, DaysInMonth, FluMonth) %>%
  summarize(IPDays = n(), ICUDays = sum(ICUMaster == "Yes")) %>%
  mutate(CensusDate = as.Date(paste0(CensusMonth, "/1/", CensusYear), format = "%m/%d/%Y"),
         IPADC = IPDays / DaysInMonth, ICUADC = ICUDays / DaysInMonth,
         SeasonType = ifelse(FluMonth == 0, "Non-Flu", "Flu"))

# Summarize daily adult med surg census across the system
ms_daily_census_system <- adult_med_surg_df %>%
  group_by(CensusDate, CensusMonth, CensusYear, DaysInMonth, FluMonth) %>%
  summarize(IPDays = n(), ICUDays = sum(ICUMaster == "Yes")) %>%
  mutate(Site = "MSHS")

# Summarize 2019 monthly adult med surg census across the system
ms_monthly_census_system <- adult_med_surg_df %>%
  filter(CensusYear == 2019) %>%
  group_by(CensusYear, CensusMonth, DaysInMonth, FluMonth) %>%
  summarize(IPDays = n(), ICUDays = sum(ICUMaster == "Yes")) %>%
  mutate(Site = "MSHS", 
         CensusDate = as.Date(paste0(CensusMonth, "/1/", CensusYear), format = "%m/%d/%Y"),
         IPADC = IPDays / DaysInMonth, ICUADC = ICUDays / DaysInMonth,
         SeasonType = ifelse(FluMonth == 0, "Non-Flu", "Flu"))

ms_daily_census_system <- ms_daily_census_system[ , colnames(ms_daily_census_site)]

ms_monthly_census_system <- ms_monthly_census_system[ , colnames(ms_monthly_census_site)]

# Bind together site and system monthly census
ms_monthly_census_summary <- rbind(ms_monthly_census_site, ms_monthly_census_system)

# Melt monthly ADC data frames for plotting
ms_monthly_census_site_melt <- melt(ms_monthly_census_site,
                                    id.vars = c("Site", "CensusDate", "SeasonType"),
                                    measure.vars = c("IPADC", "ICUADC"))

ms_monthly_census_system_melt <- melt(ms_monthly_census_system,
                                      id.vars = c("Site", "CensusDate", "SeasonType"),
                                    measure.vars = c("IPADC", "ICUADC"))

ms_monthly_census_summary_melt <- melt(ms_monthly_census_summary,
                                      id.vars = c("Site", "CensusDate", "SeasonType"),
                                    measure.vars = c("IPADC", "ICUADC"))

# Set site and season types as factor for future plots
ms_monthly_census_site_melt$Site <- factor(ms_monthly_census_site_melt$Site, levels = site_order, ordered = TRUE)

ms_monthly_census_site_melt$SeasonType <- factor(ms_monthly_census_site_melt$SeasonType, levels = flu_season_order, ordered = TRUE)

ms_monthly_census_system_melt$SeasonType <- factor(ms_monthly_census_system_melt$SeasonType, levels = flu_season_order, ordered = TRUE)

ms_monthly_census_summary_melt$Site <- factor(ms_monthly_census_summary_melt$Site, levels = site_order, ordered = TRUE)

ms_monthly_census_summary_melt$SeasonType <- factor(ms_monthly_census_summary_melt$SeasonType, levels = flu_season_order, ordered = TRUE)

# Compare ADC during flu season to non-flu season ------------------
# Summarize 2019 ADC for flu months vs non-flu months
ms_flu_season_census_site <- ms_monthly_census_site %>%
  group_by(Site, FluMonth, SeasonType) %>%
  summarize(SeasonDays = sum(DaysInMonth), IPDays = sum(IPDays), ICUDays = sum(ICUDays)) %>%
  mutate(IPADC = IPDays / SeasonDays, ICUADC = ICUDays / SeasonDays)

# Summarize 2019 ADC for flu months vs non-flu months
ms_flu_season_census_system <- ms_monthly_census_system %>%
  group_by(Site, FluMonth, SeasonType) %>%
  summarize(SeasonDays = sum(DaysInMonth), IPDays = sum(IPDays), ICUDays = sum(ICUDays)) %>%
  mutate(IPADC = IPDays / SeasonDays, ICUADC = ICUDays / SeasonDays)

# Melt data frames for plotting
ms_flu_season_census_site_melt <- melt(ms_flu_season_census_site, 
                                       id.vars = c("Site", "SeasonType"),
                                       measure.vars = c("IPADC", "ICUADC"))

ms_flu_season_census_site_melt$Site <- factor(ms_flu_season_census_site_melt$Site,
                                              levels = site_order, ordered = TRUE)

ms_flu_season_census_site_melt$SeasonType <- factor(ms_flu_season_census_site$SeasonType,
                                               levels = flu_season_order, ordered = TRUE)


```

```{r Plot ADC during flu season and nonflu season across sites}
adc_labels <- c(IPADC = "Adult Med Surg", ICUADC = "ICU")

flu_nonflu_month_plot <- ggplot(data = ms_flu_season_census_site_melt, aes(x = Site, y = value, fill = SeasonType)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(variable ~ ., scales = "free", labeller = labeller(variable = adc_labels)) +
  labs(title = "Adult Med Surg ADC for Flu and Non-Flu Months by Site", x = "Site", y = "ADC") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "bottom",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        panel.grid.major = element_line(color = "lightgrey"),
        panel.grid.minor = element_line(color = "lightgrey")) +
  geom_text(aes(label = round(value, digits = 1)), position = position_dodge(width = 1), vjust = -0.25, size = 3) +
  scale_fill_manual(name = "Flu Season", values = c("#221f72", "#00AEEF")) +
  scale_y_continuous(expand = c(0, 0, 0.1, 0))


```

```{r Custom function to plot monthly ADC for each site to compare flu and nonflu months}
monthly_adc_plot <- function(site) {
  site <- site
  
  site_df <- ms_monthly_census_site_melt %>%
    filter(Site == site)
  
  ggplot(data = site_df, aes(x = CensusDate, y = value, fill = SeasonType)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(variable ~ ., scales = "free", labeller = labeller(variable = adc_labels)) +
  labs(title = paste(site, "Adult Med Surg ADC by Month"), x = "Site", y = "ADC") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "bottom",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        panel.grid.major = element_line(color = "lightgrey"),
        panel.grid.minor = element_line(color = "lightgrey")) +
  geom_text(aes(label = round(value, digits = 1)), position = position_dodge(width = 1), vjust = -0.25, size = 3) +
  scale_fill_manual(name = "Flu Season", values = c("#221f72", "#00AEEF")) +
  scale_y_continuous(expand = c(0, 0, 0.1, 0)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%m/%y")
  
}

```

```{r Determine flu surge census using lowest nonflu and high flu months}
# Since ICUs don't see a consistent, large increase in ADC during flu season, use a different approach to determine flu surge
# Use difference between ICU ADC of lowest non-flu month and highest flu month

# Determine lowest non-flu month IP ADC and highest flu month IP ADC by site and across system
ms_non_flu_low_month <- ms_monthly_census_summary %>%
  filter(FluMonth == 0) %>%
  group_by(Site, SeasonType) %>%
  summarize(LowestNonFluIPMonth = CensusDate[which.min(IPADC)],
            LowestNonFluIPADC = IPADC[which.min(IPADC)],
            LowestNonFluICUADC = ICUADC[which.min(IPADC)])

ms_flu_high_month <- ms_monthly_census_summary %>%
  filter(FluMonth == 1) %>%
  group_by(Site, SeasonType) %>%
  summarize(HighestFluMonth = CensusDate[which.max(IPADC)],
            HighestFluIPADC = IPADC[which.max(IPADC)],
            HighestFluICUADC = ICUADC[which.max(IPADC)])

# Bind together lowest non-flu month and highest flu month by site and across system
ms_flu_low_high_months <- left_join(ms_non_flu_low_month, ms_flu_high_month, by = c("Site" = "Site"))

ms_flu_low_high_months <- ms_flu_low_high_months %>%
  mutate(FluIPADC = HighestFluIPADC - LowestNonFluIPADC,
         FluICUADC = HighestFluICUADC - LowestNonFluICUADC)
```

```{r Create data frame of census additions due to COVID steady state and flu surge}
# Create a data frame with necessary columns for COVID steady state
covid_steady_state_census_add <- covid_census_steady_state %>%
  select(Site, IPADC, CriticalCareADC) %>%
  mutate(Scenario = paste0("COVID Steady State (", format(covid_steady_state_start, "%m/%d"),"-",format(max(daily_covid_census_summary$CensusDate), "%m/%d"), ")")) %>%
  ungroup()


# Create data frame of flu surge census to later bind with COVID steady state
flu_surge_census_add <- ms_flu_low_high_months %>%
  mutate(Scenario = "Flu Surge",
         IPADC = FluIPADC,
         CriticalCareADC = FluICUADC) %>%
  select(Site, IPADC, CriticalCareADC, Scenario) %>%
  ungroup()
  
# Bind together data frames
covid_ss_flu_census_add <- rbind(covid_steady_state_census_add, flu_surge_census_add)

covid_ss_flu_census_add <- covid_ss_flu_census_add[ , c("Site", "Scenario", "IPADC", "CriticalCareADC")]

covid_ss_flu_census_add$Site <- factor(covid_ss_flu_census_add$Site,
                                       levels = site_order, ordered = TRUE)

covid_ss_flu_census_add$Scenario <- factor(covid_ss_flu_census_add$Scenario,
                                           levels = c("Flu Surge", paste0("COVID Steady State (", format(covid_steady_state_start, "%m/%d"),"-",format(max(daily_covid_census_summary$CensusDate), "%m/%d"), ")")), ordered = TRUE)

covid_ss_flu_census_add <- covid_ss_flu_census_add %>%
  arrange(Site, Scenario)

```

```{r Create kable for census additions due to flu and COVID steady state}
census_additions_table <- function(site) {
  site <- site

  census_add_site <- covid_ss_flu_census_add %>%
    filter(Site == site)

  census_add_site$Site <- NULL

  kable(census_add_site, format = "html", escape = FALSE, align = "c", digits = 1,
      col.names =c("Scenario", "IP ADC", "Critical Care ADC"),
      caption = paste(site, " Census Additions")) %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1), border_right = "thin solid lightgray", background = "white") %>%
  column_spec(column = c(2:3), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%

  column_spec(column = c(1:3), background = "inherit", color = "inherit") %>%
  add_header_above(c(" " = 1, "Census Additions" = 2), background = c("white", sinai_colors[1]), color = "white", line = FALSE)
}

```


```{r Plot ADC of lowest non flu and high flu month}

# Melt data frame for plotting
ms_flu_low_high_months_melt <- melt(ms_flu_low_high_months, id.var = c("Site"),
                                    measure.vars = c("LowestNonFluIPADC", "LowestNonFluICUADC",
                                                     "HighestFluIPADC", "HighestFluICUADC"))

ms_flu_low_high_months_melt <- ms_flu_low_high_months_melt %>%
  mutate(CensusType = ifelse(variable == "LowestNonFluIPADC" | variable == "HighestFluIPADC", "IPADC", "ICUADC"),
         MonthType = ifelse(variable == "LowestNonFluIPADC" | variable == "LowestNonFluICUADC", "Non-Flu", "Flu"))

# Set site, census type, and month type as factors
ms_flu_low_high_months_melt$Site <- factor(ms_flu_low_high_months_melt$Site,
                                           levels = site_order, ordered = TRUE)

ms_flu_low_high_months_melt$CensusType <- factor(ms_flu_low_high_months_melt$CensusType,
                                                 levels = c("IPADC", "ICUADC"), ordered = TRUE)

ms_flu_low_high_months_melt$MonthType <- factor(ms_flu_low_high_months_melt$MonthType,
                                               levels = flu_season_order, ordered = TRUE)

# Remove MSHS from data frame for plotting
ms_flu_low_high_months_site <- ms_flu_low_high_months_melt %>%
  filter(Site != "MSHS")

# Create plot of ADC for lowest non-flu and highest flu month for each site
low_high_flu_month_plot <- ggplot(data = ms_flu_low_high_months_site, aes(x = Site, y = value, fill = MonthType)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(CensusType ~ ., scales = "free", labeller = labeller(CensusType = adc_labels)) +
  labs(title = "Adult Med Surg ADC for Flu and Non-Flu Months by Site", x = "Site", y = "ADC") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        legend.position = "bottom",
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        panel.grid.major = element_line(color = "lightgrey"),
        panel.grid.minor = element_line(color = "lightgrey")) +
  geom_text(aes(label = round(value, digits = 1)), position = position_dodge(width = 1), vjust = -0.25, size = 3) +
  scale_fill_manual(name = "Flu Season", values = c("#221f72", "#00AEEF")) +
  scale_y_continuous(expand = c(0, 0, 0.1, 0))

```

## {.tabset}

### Model Updates

<h4><b>ICU Demand Model Updates:</b></h4>
1. COVID Peak Census
    + Tested two methods to determine peak critical care census. See "COVID Peak Census Methodology" table for more details.
    + Peak COVID critical care census based on day with highest critical care census, not highest IP census
    + COVID critical care census expanded to include patients on vents not in ICU
2. COVID Steady State Census
    + Based on COVID census from 5/15/20-6/7/20
3. COVID Surge Scenarios
    + Updated to include difference between historical peak and steady state census
4. Flu Surge Census Impact
    + Incorporated room and board charge data to determine census increases during flu season
    + Flu months: November, December, January, February, March
    + See "Flu Surge Methodology" tab for additional details


### Data Sources

<h4><b>Historical ICU Census Analysis</b></h4>
**Data Source:**</br>
FY2019 ICU ADC based on billing data for patients discharged from 1/1/2019-12/31/2019.</br>
Elective and non-elective breakdown based on encounter admit type.</br>
Analysis excludes peds, nursery/neonatal, obstetrics, psych, rehab, and chemical dependency encounters.
<h4></h4></br>

<h4><b>COVID-19 Census Analysis:</b></h4>
**Data Source for Epic Sites:**</br>
Epic COVID Census Day Prior reports representing census as of 11:59PM from 3/12/20-6/7/20 used as basis for census  analysis. Enterprise DataMart patient registry inpatient table used to supplement Epic report to identify additional ICU and non-ICU vent days.</br>

* Individal report name: COVID Census Prior Day.rpt
* Epic date range: 3/12/20-6/7/20

**Data Source for Non-Epic Sites:**</br>
COVID census based on Enterprise DataMart patient registry inpatient table. COVID-Negative patients excluded. 

* Table name: COVID_IP_PATIENT_DAYS_DETAIL pulled on 6/9/20 3:48PM</br>

Steady state COVID census based on census from 5/15/20-6/7/20.</br>
COVID peak scenarios based on difference between peak COVID census and steady state COVID census.</br>

**ICU classifications for Epic and non-Epic sites:**</br>
MSH, MSB, MSW, MSM, MSBI: Accommodation type of Intensive Care or Coronary Care in either Epic or Enterprise DataMart tables.</br>
MSQ: Based on unit and bed history described below.</br>

* MSQ 6 ICU: All beds always ICU
* MSQ 5 East: PACU used as ICU from 3/28/20-5/6/20
* MSQ 6 East: All beds in IMCU used as ICU from 3/28/20-5/21/20. From 5/22/20 on, rooms 601, 606, and 608 converted back to IMCU.
* MSQ 2 East: Rooms 208-217 used as ICU from 5/7/20-5/19/20
<h4></h4></br>

<h4><b>Flu Surge Census:</b></h4>
**Data Source:**</br>
Based on room and board charges for FY2019 for patients discharged from 01/19-2/20. 
</br>
Analysis excludes peds, nursery/neonatal, obstetrics, psych, rehab, and chemical dependency units. ICU days based on unit type and accommodation codes. 


### COVID Peak Census Methodology

Two methods tested to determine peak ICU census for scenario testing:

* Method 1: Utilize critical care census from date with highest COVID-19 IP census
* Method 2: Utilize critical care census from date with highest COVID-19 critical care census
```{r Create kable comparing two methods of calculating peak ICU census}
kable(covid_census_peaks, format = "html", escape = FALSE, align = "c", 
      col.names = c("Site", "Date", "IP Census", "ICU Census", "Non-ICU Vent Census", "Critical Care Census", "Date", "IP Census", "ICU Census", "Non-ICU Vent Census", "Critical Care Census"),
      caption = "Peak Critical Care Census Methodology Comparison") %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 6), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:6), background = sinai_colors[1], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(7:11), background = sinai_colors[2], color = "white", include_thead =  TRUE) %>%
  column_spec(column = c(2:11), background = "inherit", color = "inherit") %>%
  # row_spec(row = 0, background = "#221f72", color = "white") %>%
  row_spec(row = nrow(covid_census_peaks), background = "lightgrey", bold = T) %>%
  add_header_above(c("Site" = 1, "Method 1: Peak COVID-19 IP Census" = 5, "Method 2: Peak COVID-19 Critical Care Census" = 5), background = c("", sinai_colors[1], sinai_colors[2]), color = "white", line = FALSE)

```
<h4><b>Method 2 provides more conservative critical care census projections and will be used moving forward.</b></h4>

### Flu Surge Methodology
#### Flu vs Non-Flu ADC
```{r Plot summary of ADC for flu and non flu months by site}
flu_nonflu_month_plot

```

<h4><b>ICUs at each site do not always see a drasticincrease in census during flu months.</b></h4>
</br>

#### Lowest Non-Flu and Highest Flu Month ADC
Instead of determining flu surge by using the difference in ADC across flu months vs. non-flu months, utilize the difference between the ADC int he highest flu month and ADC in lowest non-flu month for a conservative estimate of flu impact to census.
```{r Low High Plot}
low_high_flu_month_plot
```

<h4><b>Moving forward, use difference between lowest non-flu month and highest flu month as flu surge census.</b></h4>
</br>

#### Monthly ADC by Site
```{r Plot MSH monthly ADC}
monthly_adc_plot(site = "MSH")
```

```{r Plot MSQ monthly ADC}
monthly_adc_plot(site = "MSQ")
```

```{r Plot MSB monthly ADC}
monthly_adc_plot(site = "MSB")
```

```{r Plot MSBI monthly ADC}
monthly_adc_plot(site = "MSBI")
```

```{r Plot MSM monthly ADC}
monthly_adc_plot(site = "MSM")
```

```{r Plot MSW monthly ADC}
monthly_adc_plot(site = "MSW")
```

<!-- ## Critical Care Census Projections -->
### MSHS
<h3>MSHS Critical Care Demand</h3>
*Excludes MSSN*
```{r Create tables for MSHS}
icu_census_project(site = "MSHS")

census_additions_table(site = "MSHS")

covid_census_project(site = "MSHS")

```

### MSH
#### MSH Critical Care Demand
```{r Create tables for MSH}
icu_census_project(site = "MSH")

census_additions_table(site = "MSH")

covid_census_project(site = "MSH")

```

### MSQ
#### MSQ Critical Care Demand
```{r Create tables for MSQ}
icu_census_project(site = "MSQ")

census_additions_table(site = "MSQ")

covid_census_project(site = "MSQ")

```

### MSB
#### MSB Critical Care Demand
```{r Create tables for MSB}
icu_census_project(site = "MSB")

census_additions_table(site = "MSB")

covid_census_project(site = "MSB")

```

### MSBI
#### MSBI Critical Care Demand
```{r Create tables for MSBI}
icu_census_project(site = "MSBI")

census_additions_table(site = "MSBI")

covid_census_project(site = "MSBI")

```

### MSM
#### MSM Critical Care Demand
```{r Create tables for MSM}
icu_census_project(site = "MSM")

census_additions_table(site = "MSM")

covid_census_project(site = "MSM")

```

### MSW
#### MSW Critical Care Demand
```{r Create tables for MSW}
icu_census_project(site = "MSW")

census_additions_table(site = "MSW")

covid_census_project(site = "MSW")

```





